<!--suppress ALL -->
<template>
    <div id="user_store" class="body">
        <CustomHeader :title="title" :needReturn="true" />
        <Auth v-if="getAuth" @close="closeAuth" />
        <div v-if="!isMember && registered" class="bgff user-mobile-box">
            <div class="user_mobile_box_container">
                <form report-submit="true" @submit="uploadFormId">
                    <button form-type="submit" class="user-mobile-get-btn" open-type="getPhoneNumber" @getphonenumber="getPhoneNumber">
                        手机号授权
                    </button>
                </form>

                <em class="mobile_box_tips">
                    我们需要您的手机号来创建账号，累计积分
                </em>
            </div>

        </div>
        <div id="store_header" :style="{'top': (statusBarHeight + navHeight) + 'px'}">
            <input type="text" placeholder="请输入商品名称" id="store_search">
            <i class="iconfont">&#xe65c;</i>
        </div>
        <div id="store_goods" :style="{'height' : (screenHeight - statusBarHeight - navHeight - 120) + 'px'}">
            <ul id="store_goods_type">
                <li
                  v-for="item in categories"
                  :key="item.id"
                  :class="item.id === activeTab ? 'active': ''"
                  @click="tabSelect(item.id)"
                >
                    {{item.name}}
                </li>
            </ul>
            <ul id="store_goods_items">
                <li v-for="item in goods" :key="index"  @click="redirectTo('user.goodDetail', {query: {type:'mall', good_id: item.id}})">
                    <div class="thumb_img">
                        <img :src="item.main_image" alt="">
                    </div>
                    <div class="selledout" v-if="!item.stock">
                        <span class="selloutConent">已抢光</span>
                    </div>
                    <div id="store_good_info">
                        <div class="store_good_info_title">
                            <h3>{{item.name}}</h3>
                            <span>{{item.unit}}</span>
                        </div>
                        <div id="store_good_info_entities">
                            <span>销量:{{item.sell_num}}</span>
                            <span>库存:{{item.stock}}</span>
                        </div>
                        <span id="store_good_info_spec" v-if="item.specifications.length">规格：{{item.spec}}</span>
                        <div id="store_good_info_price">
                            <span>{{item.sell_price_format}}</span>
                            <em>{{item.origin_price_format}}</em>
                            <i class="iconfont add" v-if="item.stock" @click.stop="addToShoppingCart(item)">&#xe6d8;</i>
                            <i class="iconfont disabledAdd" v-else>&#xe670;</i>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <ShoppingCart v-if="registered && isMember" :type="'mall'"/>
        <SelectSpecification
            :selectSpec="selectSpec"
            :item="selectItem"
            :type="'mall'"
            @close="closeSelectSpec" />
        <ChooseSelfRaisingPoint v-if="showPoints" @close="closePoints" />
    </div>
</template>
<script>
	import CustomHeader from '../../../components/CustomHeader';
    import Auth from '../../../components/Auth';
	import ShoppingCart from '@/components/ShoppingCart';
	import ChooseSelfRaisingPoint from '@/components/ChooseSelfRaisingPoint';
	import SelectSpecification from '@/components/SelectSpecification';
	import _ from 'underscore'

  export default {
      components: {
		  CustomHeader,
          ShoppingCart,
          SelectSpecification,
		  ChooseSelfRaisingPoint,
		  Auth
      },
      data() {
          return {
              title: '商城',
              navName: 'store',
              activeTab:'',
			  selectSpec:false,
			  selectItem:{},
			  getAuth: false,
              screenHeight: 0,
              queryCateId: ''
          };
      },
      onShareAppMessage: function (res) {
          //可以先看看页面数据都有什么，得到你想要的数据
          console.log(this.shopCode, '==========>');
          return {
              title: "青松易购预定商城",
              desc: "青松易购小程序",
              imageUrl: "分享要显示的图片，如果不设置就会默认截图当前页面的图片",
              path: `/pages/user/store/main?backHome=true&shop_code=${this.storeId || this.shopCode}`,

              success: function (res) {
                  // 转发成功
                  console.log("转发成功:" + JSON.stringify(res));
              },
              fail: function (res) {
                  // 转发失败
                  console.log("转发失败:" + JSON.stringify(res));
              }
          }
      },
      watch: {
		  activeTab(val) {
			  if(val){
                  this.$command('LOAD_STORE_COMMAND',val,1)
              }
          },
		  isMember (value) {
			  if (value) {
			  }
		  },
          registered (val) {
              if (val) {
                  this.getAuth = false;
              }
          },
          queryCateId (val) {
              if (val) {
                  this.tabSelect(val)
              }
          }
      },
      computed: {
          shopCode () {
              return this.model.account.shopCode
          },
          categories(){
            let categories = this.model.user.store.categories;
            if(categories && categories.length && !this.queryCateId){
                this.activeTab = categories[0].id
            }
          	 return categories;
          },
          goods(){
			  return this.model.user.store.goods
          },
          showPoints () {
			  return this.model.user.store.showPoints
          },
		  statusBarHeight () {
			  return this.model.global.barHeight.statusBarHeight
		  },
		  navHeight () {
			  return this.model.global.barHeight.navHeight
		  },
		  registered () {
			  return this.model.account.registered;
		  },
		  isMember () {
			  return this.model.account.isMember;
		  },
      },
      onShow () {
          this.queryCateId = ''
      },
      methods: {
          async uploadFormId (e) {
              let formId = e.mp.detail.formId;
              if (formId !== "the formId is a mock one"){
                  await this.http.account.saveFormId(formId);
              } else {
                  console.log('form id 不合法')
              }
          },
		  getPhoneNumber (e) {
              console.log(e, '----------------store---------------');
              this.$command('SET_USER_MOBILE', e);
		  },
		  getUserAuth () {
			  this.getAuth = true
		  },
		  closeAuth () {
			  this.getAuth = false
		  },
		  closePoints () {
             this.showPoints = false
          },
          tabSelect(id){
              this.activeTab = id;
			  this.$command('LOAD_STORE_COMMAND',id, 1)
          },
          setData(data){
              this.data = data
          },
        addToShoppingCart(item){
		  	if (!this.registered) {
		  		this.getUserAuth()
            } else {
				if (!this.isMember) {
				} else {
					if (item.specifications.length) {
						this.selectItem = item;
						this.selectSpec = true
					} else {
						let goods = this.model.user.store.goodInShoppingCart;
						if (goods.length) {
							_.map(goods, (product) => {
								product['product_stock_id'] === item['product_entities'][0]['product_stock_id']?
									this.$command('CHANGE_BUY_NUM_COMMAND',product,product['buy_num'] + 1,'mall')
									:
									this.$command('ADD_GOODS_TO_CART_COMMAND',item['product_entities'][0]['product_stock_id'],1,'mall')
							})
						} else {
							this.$command('ADD_GOODS_TO_CART_COMMAND',item['product_entities'][0]['product_stock_id'],1,'mall')
						}

					}
                }

            }
        },
		  closeSelectSpec(){
              this.selectSpec = false
          },
		  redirectTo (router, options = {}) {
			  this.$command('REDIRECT_TO', router, 'push', options);
		  },
      },
      created() {
      },
      onShow () {
          let pages =  getCurrentPages();
          let options = pages[pages.length - 1]['options'];
          this.storeId = options['shop_code'] ? options['shop_code'] : '';
          if (this.storeId) {
              this.model.account.dispatch('saveShopCode', {
                  code: this.storeId
              })
          }
          if (this.storeId && this.registered ) {
              console.log('进来了吗');
              this.$command('BIND_CONSUMER', this.storeId)
          }
      },
      mounted() {
          let rpxRate = 750 / wx.getSystemInfoSync().windowWidth;
          let screenWitdh = wx.getSystemInfoSync().windowHeight;
          this.screenHeight = (rpxRate * screenWitdh)/ 2;
          console.log(this.screenHeight);
          this.$command('LOAD_STORE_CATEGORIES_COMMAND')
          if (this.$route.query && this.$route.query.cateId) {
              this.queryCateId = this.$route.query.cateId
          }
	  }
	}
</script>

<style>
	page {
        height: 100%;
        background: #fff;
    }

	#footNavHeight {
        height: 109rpx;
	}

    #user_store{
        height: 100%;
        overflow-y: hidden;
        background: #fff;
    }

  #select_spec{
    width: 100%;
    height: 100%;
    position: fixed;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;

  }

  #shopping_cart{
      position: fixed;
      width: 100%;
      transition: 1s;
  }

  #store_header{
      box-sizing: border-box;
      width: 100%;
      height: 108rpx;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      background: #fff;
      border-bottom: 2rpx solid #f2f2f2;
      position: fixed;
  }

  #store_header #store_search {
      width: 630rpx;
      height: 70rpx;
      background: #f2f2f2;
      border-radius: 10rpx;
      padding: 0 40rpx;
      font-size: 28rpx;
  }

  #store_header i{
      position: absolute;
      right: 70rpx;
      top: 34rpx;
      font-size: 40rpx;
      color: #757575;
  }

  #store_goods {
      display: flex;
      justify-content: flex-end;
      align-items: flex-start;
      margin-top: 108rpx;
      overflow-y: auto;
  }

  #store_goods #store_goods_type {
      flex: 1;
      position: fixed;
      left: 0;
      height: 1250rpx;
      overflow: scroll;
      background: #f2f2f2;
  }

  #store_goods #store_goods_type li {
    width: 150rpx;
    height: 120rpx;
    font-size: 28rpx;
    color: #111111;
    display: flex;
    justify-content: center;
    align-items: center;
      font-weight: bold;
  }

  #store_good_info_spec{
      font-size: 22rpx;
      color: #757575;
  }

  #store_goods #store_goods_type .active{
      background: #fff;
      border-left: 12rpx solid #ffcc00;
  }

  #store_goods #store_goods_items{
      width: 600rpx;
      background: #fff;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      flex-direction: column;
  }

  #store_goods #store_goods_items li{
    width: 560rpx;
    padding: 20rpx;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    border-bottom: 2rpx solid #f2f2f2;
      position: relative;
  }

    #store_goods #store_goods_items .thumb_img{
        margin-right: 30rpx;
        width: 190rpx;
        height: 190rpx;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #store_goods #store_goods_items .thumb_img img{
        width: 100%;
        height: 100%;
    }

    .selledout{
        position: absolute;
        width: 190rpx;
        height: 190rpx;
        top: 20rpx;
        left: 20rpx;
        background: rgba(255,255,255,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .selloutConent{
        width: 50%;
        height: 40rpx;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 30px;
        background: rgba(0,0,0,0.4);
        color: #fff;
        font-size: 24rpx;
        margin-top: 70rpx;
    }

  #store_goods #store_goods_items #store_good_info{
      flex: 1;
  }

    #store_goods #store_goods_items .store_good_info_title{
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #store_goods #store_goods_items .store_good_info_title span{
        font-size: 24rpx;
        color: #757575;
        margin-right: 40rpx;
    }

  #store_goods #store_goods_items #store_good_info h3{
      font-size: 28rpx;
      color: #111111;
      margin: 10rpx 0;
      width: 200rpx;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
  }

  #store_goods #store_goods_items #store_good_info #store_good_info_entities span{
      font-size: 22rpx;
      color: #757575;
  }

  #store_goods #store_goods_items #store_good_info #store_good_info_entities span:last-child{
      margin-left: 30rpx;
  }

  #store_goods #store_goods_items #store_good_info #store_good_info_price{
      width: 100%;
      margin-top: 26rpx;
      display: flex;
      justify-content: space-between;
      padding-right: 20rpx;
      align-items: center;
  }

  #store_goods #store_goods_items #store_good_info #store_good_info_price span{
      font-size: 32rpx;
      display: inline-block;
      height: 100%;
      color: #ffcc00;
  }

  #store_goods #store_goods_items #store_good_info #store_good_info_price em {
      font-size: 22rpx;
      color: #757575;
      display: inline-block;
      height: 100%;
      text-decoration: line-through;
  }

  #store_goods #store_goods_items #store_good_info #store_good_info_price .add{
      background: linear-gradient(to right,#FDE068,#FFCC00);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 48rpx;
      margin-right: 20rpx;
      margin-left: 70rpx;
  }

  .disabledAdd{
      color: #e5e5e5;
        font-size: 48rpx;
      margin-right: 20rpx;
      margin-left: 70rpx;
  }

    .user-mobile-box{
        position: fixed;
        height: 100%;
        width: 100%;
        background: rgba(0, 0, 0, .3);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .user-mobile-box .user_mobile_box_container{
        position: absolute;
        background: #FFFFFF;
        width: 620rpx;
        border-radius: 10rpx;
        top: 338rpx;
        left: 65rpx;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .user-mobile-get-btn {
        height: 80rpx;
        width: 320rpx;
        text-align: center;
        line-height: 80rpx;
        background: #FECE00;
        margin-top: 80rpx;
        margin-bottom: 40rpx;
        display: block;
        font-size: 32rpx;
        font-weight: 200;
        border: 0;
        border-radius: 80rpx;
        box-shadow: 0 10rpx 10rpx #fff6bd;
    }

    .mobile_box_tips {
        text-align: center;
        line-height: 96rpx;
        border-radius: 10rpx 10rpx 0 0;
        font-size: 29rpx;
        font-weight: 400;
    }


</style>
