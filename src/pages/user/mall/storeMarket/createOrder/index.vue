<template>
    <div class="confirmation-order body">
        <mp-title :title="title"></mp-title>
        <!-- 收货人组件 -->
        <consignee select-method="true"></consignee>
        <!-- 配送和自提的tab切换组件-->
        <order-type v-model="addressInfo"></order-type>
        <!-- 支付内容的显示组件 -->
        <payment :model="model" :usedTicket="usedTicket" :totalNum="totalNum" :ticketNum="ticketNum" :createOrder="createOrder" :addMerchandiseToCart="addCart" :reduceMerchandiseToCart="reduceCart" :redirectToTicket="redirectToTicket"></payment>
    </div>
</template>
<script>
import MpTitle from '@/components/MpTitle';
import Consignee from '@/components/Consignee';
import OrderType from './OrderType';
import Payment from '@/components/Payment';
import { SEND_ORDER_TO_USER, USER_SELF_PICK_UP } from '@/utils/OrderDict';
export default {
    name: 'confirmationOrder',
    data () {
        return {
            title: '确认订单「当日」',
            model: 'model.storeMarket.shoppingCarts',
            storeId: null,
            roomNum: null,
            buildNum: null,
            addressInfo: {
                address: null,
                buildingNum: null,
                roomNum: null,
                sendBatch: 0,
                currentTab: 0
            },
			orderId: null,
			paid: false
        }
    },
    components: {
        'mp-title': MpTitle,
        'consignee': Consignee,
        'order-type': OrderType,
        'payment': Payment
    },
    computed: {
        userInfo () {
            return this.$store.getters['model.account/userInfo']
        },
        storeInfo () {
            return this.$store.getters['model.nearestStore/store']
        },
        ticketNum () {
            return this.$store.getters['model.store.tickets/totalNum'];
        },
        totalAmount () {
            return this.model ? this.$store.getters[`model.store.shoppingCarts/totalAmount`] : 0;
        },
        usedTicket () {
            return this.$store.getters['model.store.shoppingCarts/usedTicketTitle'];
        },
        usedTicketCode () {
            return this.$store.getters['model.store.shoppingCarts/ticketCode'];
        },
        usedCardId () {
            return this.$store.getters['model.store.shoppingCarts/cardId'];
        }
    },
    methods: {
        redirectToTicket () {
            this.mp.router.push('storeMarket.coupons', {
                query: {
                    back_to: 'storeMarket.createOrder'
                }
            });
        },
        radioChange (e) {
            console.log('radio发生change事件，携带value值为：', e.target.value)
        },
        bindPickerChange (e) {
            this.index = e.target.value
        },
        addCart (merchandiseId, id = null) {
            let count = this.$store.getters['model.store.shoppingCarts/quality'](merchandiseId) + 1;
            this.$command('STORE_SHOPPINGCART_CHANGE_MERCHANDISE', this.nearestStore['id'], merchandiseId, id, count);
        },
        reduceCart (merchandiseId, id = null) {
            let count = this.$store.getters['model.store.shoppingCarts/quality'](merchandiseId) - 1;
            this.$command('STORE_SHOPPINGCART_CHANGE_MERCHANDISE', this.nearestStore['id'], merchandiseId, id, count);
        },
        createOrder () {
            let type = null;
            if (this.addressInfo.currentTab === 1) {
                type = USER_SELF_PICK_UP;
            } else if (this.addressInfo.currentTab === 0) {
                type = SEND_ORDER_TO_USER;
            }
            if (type === SEND_ORDER_TO_USER && (this.addressInfo.buildingNum === null || this.addressInfo.roomNum === null)) {
                wx.showToast({
                    title: '楼号或房号不得为空',
                    icon: 'none'
                })
                return false;
            }
            //
			if(!this.orderId && !this.paid) {
				this.$command(
				    'CREATE_STORE_ORDER',
				    type,
				    this.storeInfo.id,
				    this.userInfo.nickname,
				    this.userInfo.mobile,
				    this.storeInfo.address,
				    this.addressInfo.buildingNum,
				    this.addressInfo.roomNum,
				    this.addressInfo.sendBatch,
				    this.usedTicketCode,
				    this.usedCardId
				);
			}else if(this.orderId && this.paid) {
				
			}
            
        },
        async initData () {
            await this.$command('LOAD_STORE_TICKETS', this.storeInfo.id);
            this.addressInfo.address = this.storeInfo.address;
        }
    },
    mounted () {
		this.orderId = null;
		this.paid = false;
        this.initData();
    }
}
</script>
<style scoped>
.confirmation-order {
    font-size: 28rpx;
    padding: 20rpx 0rpx 20rpx 20rpx;
}
</style>
